---
title: "MLR"
author: "Yijia Sun"
date: "2022-11-20"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(dplyr)
library(ggplot2)
library(ggpubr)
library(gtrendsR)
library(usmap)
library(tidyr)
library(janitor)
library(psych)
library(knitr)
library(broom)
library(cowplot) # use plot_grid function
library(patchwork)
library(knitr) 
library(broom) 
library(rstatix)
library(stargazer)
```

Incorporate a summarized and corrected version of the EDA report from the previous project update.

# Import Data

```{r}
df <- read_csv("data/mod_abortion_data.csv")
df <- df[, -c(1)]
glimpse(df)
```

## EDA

First, we check the distribution of outcome variables. The histograms below indicate that both distribution is right-skewed.

```{r}
his1 <- ggplot(df, aes(x = abortion_rate_residence)) +
  geom_histogram(aes(y=..density..), colour="black", fill="white") +
  geom_density(alpha=.2, fill="#FF6666") +
  #facet_grid(year ~ ., scales = "free") + 
  xlab("abortion rate by state of residence") + ggtitle("Histogram for Abortion rate by State of Residence")

his2 <- ggplot(df, aes(x = percentage_leaving)) +
  geom_histogram(aes(y=..density..), colour="black", fill="white") +
  geom_density(alpha=.2, fill="#FF6666") +
  #facet_grid(year ~ ., scales = "free") + 
  xlab("percentage of leaving") + ggtitle("Histogram for Percentage of Leaving")

his1 + his2
```

Then, we check the relationship between each outcome variables and the main covariates of interest `policy_index`. Dotplots below indicate the linear relationship between each outcome variables and policy index.

```{r}
dot1 <- ggplot(df, aes(x = policy_index, y = abortion_rate_residence)) +
  geom_point() +
  xlab("abortion policy index") +
  ylab("abortion rate by state of residence") + 
  ggtitle("Abortion Rate vs. Policy Index") +
  geom_smooth(method ="lm")

dot2 <- ggplot(df, aes(x = policy_index, y = percentage_leaving)) +
  geom_point() +
  xlab("abortion policy index") +
  ylab("percentage of leaving") + 
  ggtitle("Percentage of Leaving vs. Policy Index") + 
  geom_smooth(method ="lm")

dot1 + dot2
```


Then, we use correlation plots to check the level of interaction between the variables. Based on the correlation matrix below, we find four pairs of variables to be significantly correlated: `policy_index` & `facility_density`, `facilities_only_medication` & `facilities_both`, `independent_clinics` & `planned_parenthoods`, and `cost_medication` & `cost_first_trimester`.

```{r}
correlation <- df[, -c(1,19)]
corr <- round(cor(correlation,use="pairwise.complete.obs"), 1)
corrplot(corr, tl.col = "brown", bg = "White", tl.srt=30, tl.cex =0.7,type = "upper")
```




Brief explanation of the modeling approach and why you chose the model type. This should include the model type, model selection procedure, and interaction terms you’re considering for the final model.

# Building the Model

We will use multiple linear regression model to generate inference to the general relationship between abortion policy and outcome in the United States. Based on the dotplots, we can identify some linear relationship between abortion rate/percentage of leaving and policy index. Therefore, we start building out model with multiple linear regression.

For each regression model, we will first evaluate the missing value rate, then conduct model selection with AIC by removing the insignificant variables and adding new interaction terms.

## Missing Value Evaluation

```{r}
colSums(is.na(df))
```


## ANOVA

```{r}
anova <- aov(abortion_rate_residence ~ factor(year) + factor(policy_catog), data = df)
summary(anova)

anova2 <- aov(percentage_leaving ~ factor(year) + factor(policy_catog), data = df)
summary(anova2)
```

Output of the final model. Note: The final model will be the result of numerous iterations and trying different models. You can include the other models you consider in the “Additional work” section at the end of the analysis write-up.

## MLR

`policy_index` & `facility_density`, `facilities_only_medication` & `facilities_both`, `independent_clinics` & `planned_parenthoods`

```{r}
df1 <- df[, -c(1, 5, 12, 13, 14, 19)]

linear_reg <- lm(abortion_rate_residence
                 ~ .
                 + policy_index * facility_density
                 + facilities_only_medication * facilities_both
                 + independent_clinics * planned_parenthoods,
                 data = df1) 

step(linear_reg, k = 2)

lm <- lm(abortion_rate_residence ~ policy_index + facility_density + 
    facilities_only_procedural + facilities_only_medication + 
    facilities_both + gestational_limit_procedural + poverty + 
    policy_index:facility_density, data = df1)

summary(lm)
tidy(lm) %>%
  kable(format = "markdown", digits = 3)

par(mfrow = c(2, 2))
plot(lm)
```



```{r}
df2 <- df[, -c(1, 2,4, 12,13,14,19)]

linear_reg2 <- lm(percentage_leaving
                 ~ .
                 + policy_index * facility_density
                 + facilities_only_medication * facilities_both
                 + independent_clinics * planned_parenthoods,
                 data = df2) 

step(linear_reg2, k = 2)

lm2 <- lm(percentage_leaving ~ policy_index + facility_density + 
    facilities_only_medication + facilities_both + independent_clinics + 
    planned_parenthoods + poverty + policy_index:facility_density + 
    independent_clinics:planned_parenthoods, data = df2)

summary(lm2)
tidy(lm2) %>%
  kable(format = "markdown", digits = 3)

par(mfrow = c(2, 2))
plot(lm2)
```


Discussion of the assumptions for the final model

Interpretations and interesting findings from the model coefficients

Additional work on other models or analysis not included in the final model.



